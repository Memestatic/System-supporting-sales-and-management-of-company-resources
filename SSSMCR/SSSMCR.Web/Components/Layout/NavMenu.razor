<MudNavMenu>
    <MudDivider Class="my-2" />
    <MudList T="object" Dense="true">
        @if (!string.IsNullOrEmpty(_email))
        {
            <MudNavLink Href="/userpanel">
                <MudListItem >
                    <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Class="mr-2" />
                    <MudText>@(string.IsNullOrWhiteSpace(_email) ? "" : _email)</MudText>
                </MudListItem>
            </MudNavLink>
        }
        @if (!string.IsNullOrWhiteSpace(_email))
        {
            <MudListItem> 
                <MudButton Variant="Variant.Text"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Logout"
                           OnClick="Logout">
                    Logout
                </MudButton>
            </MudListItem>
        }
        @if (string.IsNullOrWhiteSpace(_email)){
            <MudListItem>
                <MudButton Variant="Variant.Text"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.Logout"
                           OnClick="RedirectToLogin">
                    Login
                </MudButton>
            </MudListItem>
        }

    </MudList>
    
    <MudNavGroup Title="Sales" Icon="@Icons.Material.Filled.PointOfSale" Expanded="false">
        <MudNavLink Href="orders" Icon="@Icons.Material.Filled.Receipt" Match="NavLinkMatch.Prefix">Orders</MudNavLink>
        <MudNavLink Href="invoices" Icon="@Icons.Material.Filled.ReceiptLong">Invoices</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Warehouse" Icon="@Icons.Material.Filled.Inventory2">
        <MudNavLink Href="stocks" Disabled="false">Stock</MudNavLink>
        <MudNavLink Href="reservations">Reservations</MudNavLink>
        <MudNavLink Href="suppliers" Disabled="true">Suppliers</MudNavLink>
    </MudNavGroup>
    
    
        @if (user_role == "Administrator")
        {
            <MudNavGroup Title="System management" Icon="@Icons.Material.Filled.Settings" >
                <MudNavLink Href="/users" Icon="@Icons.Material.Filled.Badge">
                    Users
                </MudNavLink>
                <MudNavLink Href="/branches" Icon="@Icons.Material.Filled.Warehouse">
                    Branches
                </MudNavLink>
                <MudNavLink Href="/products" Icon="@Icons.Material.Filled.Inventory2">
                    Products
                </MudNavLink>
            </MudNavGroup>
        }
        else if (user_role == "Inna")
        {
            
        }
        
    

</MudNavMenu>


@code {
    [Inject] Blazored.LocalStorage.ILocalStorageService LocalStorage { get; set; } = default!;
    [Inject] IAuthService Auth { get; set; } = default!;
    [Inject] NavigationManager Nav { get; set; } = default!;
    private string? _email;
    private string? user_role;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var token = await LocalStorage.GetItemAsync<string>("jwt");
        var expires = await LocalStorage.GetItemAsync<DateTime?>("jwt_expires");
        
        try
        {
            if (!string.IsNullOrWhiteSpace(token) && expires is not null && expires > DateTime.UtcNow)
            {
                _email = await LocalStorage.GetItemAsStringAsync("user_email");
                user_role = await LocalStorage.GetItemAsync<string>("user_role");
            }
        }
        catch (InvalidOperationException)
        {
            
        }
        StateHasChanged();
    }
    
    private async Task Logout()
    {
        await Auth.LogoutAsync();
        _email = null;
        user_role = null;
        Nav.NavigateTo("login", replace: true);
        StateHasChanged();
    }

    private async Task RedirectToLogin()
    {
        StateHasChanged();
        Nav.NavigateTo("/login");
    }
    
    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    
    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        try
        {
            _email = await LocalStorage.GetItemAsStringAsync("user_email");
            user_role = await LocalStorage.GetItemAsync<string>("user_role");
        }
        catch (Exception)
        {
        
        }
        StateHasChanged();
    }

    
    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

}
