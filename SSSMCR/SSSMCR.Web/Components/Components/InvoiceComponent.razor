@inject InvoiceApiService InvoiceService
@using MudBlazor
@using SSSMCR.Web.Services
@inject IJSRuntime JS

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h6">Generate Invoice</MudText>

    <MudTextField @bind-Value="OrderId" Label="Order ID" Variant="Variant.Outlined" />

    <MudButton OnClick="GenerateInvoice" Color="Color.Primary" Variant="Variant.Filled" Class="mt-3">
        Show Invoice
    </MudButton>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2">
            @ErrorMessage
        </MudAlert>
    }
    
    @if (!string.IsNullOrEmpty(PdfDataUrl))
    {
        <MudDivider Class="my-4" />
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.subtitle1">Preview</MudText>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       OnClick="OpenPdfInNewTab"
                       StartIcon="@Icons.Material.Filled.OpenInNew">
                Open in new tab
            </MudButton>
            <MudButton Variant="Variant.Text"
                       Color="Color.Secondary"
                       Href="@PdfDataUrl"
                       Download="invoice.pdf"
                       StartIcon="@Icons.Material.Filled.Download">
                Download PDF
            </MudButton>
        </MudStack>

        <MudPaper Class="mt-2" Style="height:80vh; overflow:hidden;">
            <iframe src="@PdfDataUrl"
                    title="Invoice PDF"
                    width="100%"
                    height="100%"
                    style="border:0;"></iframe>
        </MudPaper>
    }
</MudPaper>

@code {
    private int OrderId { get; set; }
    private string? ErrorMessage { get; set; }
    private string? PdfDataUrl { get; set; }

    private async Task GenerateInvoice()
    {
        ErrorMessage = null;
        PdfDataUrl = null;

        var dataUrl = await InvoiceService.GetInvoiceDataUrlAsync(OrderId);
        if (string.IsNullOrEmpty(dataUrl))
        {
            ErrorMessage = "Failed to generate invoice.";
        }
        else
        {
            PdfDataUrl = dataUrl;
        }
    }

    private async Task OpenPdfInNewTab()
    {
        if (!string.IsNullOrEmpty(PdfDataUrl))
        {
            await JS.InvokeVoidAsync("open", PdfDataUrl, "_blank", "noopener");
        }
    }
}